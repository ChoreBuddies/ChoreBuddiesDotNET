@page "/signup"

@inject IAuthApiService authApiService
@inject TimeProvider timeProvider
@inject NavigationManager navigationManager

<AuthorizeView>
    <Authorized>
        @{
            Console.WriteLine("User is already authorized, redirecting to home page.");
            navigationManager.NavigateTo("/");
        }
    </Authorized>
</AuthorizeView>

<MudContainer Style="justify-content: center" MaxWidth="MaxWidth.Small">
    <MudPaper Class="pa-4">
        <MudText Typo="Typo.h4" Align="Align.Center" Color="Color.Secondary" Class="mb-4">Signup</MudText>

        <MudForm @ref="form" @bind-IsValid="@success" @bind-Errors="@errors">
            <MudGrid Spacing="2">

                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="firstName" T="string" Label="First Name"
                                  Required="true" RequiredError="First name is required!"
                                  Variant="Variant.Outlined" Margin="Margin.Dense" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="lastName" T="string" Label="Last Name"
                                  Required="true" RequiredError="Last name is required!"
                                  Variant="Variant.Outlined" Margin="Margin.Dense" />
                </MudItem>

                <MudItem xs="12">
                    <MudDatePicker @bind-Date="dateOfBirth" Label="Date of Birth"
                                   Required="true" RequiredError="Date of birth is required!"
                                   Editable="true"
                                   Variant="Variant.Outlined" Margin="Margin.Dense"
                                   MaxDate="@MaxAllowedDate"
                                   MinDate="@MinAllowedDate"
                                   HelperText="Must be between 4 and 120 years old" />
                </MudItem>

                <MudItem xs="12">
                    <MudTextField @bind-Value="username" T="string" Label="Username"
                                  Required="true" RequiredError="User name is required!"
                                  Variant="Variant.Outlined" Margin="Margin.Dense" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField @bind-Value="email" T="string" Label="Email"
                                  Required="true" RequiredError="Email is required!"
                                  Validation="@(new EmailAddressAttribute() {ErrorMessage = "The email address is invalid"})"
                                  Variant="Variant.Outlined" Margin="Margin.Dense" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="password" T="string" Label="Password"
                                  HelperText="Choose a strong password"
                                  InputType="@(_showPassword ? InputType.Text : InputType.Password)"
                                  Required="true" RequiredError="Password is required!"
                                  Variant="Variant.Outlined" Margin="Margin.Dense"
                                  Adornment="Adornment.End" OnAdornmentClick="TogglePasswordVisibility"
                                  AdornmentIcon="@(_showPassword ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField T="string" Label="Repeat Password"
                                  HelperText="Repeat the password"
                                  InputType="@(_showRepeatPassword ? InputType.Text : InputType.Password)"
                                  Validation="@(new Func<string, string>(PasswordMatch))"
                                  Variant="Variant.Outlined" Margin="Margin.Dense"
                                  Adornment="Adornment.End" OnAdornmentClick="ToggleRepeatPasswordVisibility"
                                  AdornmentIcon="@(_showRepeatPassword ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)" />
                </MudItem>

                <MudItem xs="12" Class="d-flex align-center justify-space-between mt-2">
                    <MudCheckBox Color="Color.Primary" T="bool" Required="true" RequiredError="You must agree" Label="I agree!" />
                    <MudButton Disabled="@(!success)" Variant="Variant.Filled" Color="Color.Primary" OnClick="@SignUpAction" Class="ml-auto px-6" Style="text-transform: none;">Sign Up</MudButton>
                </MudItem>

            </MudGrid>
        </MudForm>
    </MudPaper>
</MudContainer>

@code {
    MudForm? form;
    bool success;
    string[] errors = { };

    string email = "";
    string firstName = "";
    string lastName = "";
    DateTime? dateOfBirth;
    string password = "";
    string username = "";

    // Allowed date range for date of birth picker (from 4 years to 120 years ago)
    DateTime MaxAllowedDate => timeProvider.GetUtcNow().AddYears(-4).UtcDateTime;
    DateTime MinAllowedDate => timeProvider.GetUtcNow().AddYears(-120).UtcDateTime;

    private bool _showPassword;
    private bool _showRepeatPassword;

    private string PasswordMatch(string arg)
    {
        if (password != arg)
            return "Passwords don't match";
        return String.Empty;
    }

    private async Task SignUpAction()
    {
        if (form is null) return;

        await form.Validate();

        if (!form.IsValid)
            return;

        if (dateOfBirth > MaxAllowedDate || dateOfBirth < MinAllowedDate)
        {
            return;
        }

        var succeeded = await authApiService.SignupAsync(new RegisterRequestDto(email, password,
            firstName, lastName, dateOfBirth!.Value, username));

        if (succeeded)
        {
            navigationManager.NavigateTo("/");
            StateHasChanged();
        }
    }

    private void TogglePasswordVisibility()
    {
        _showPassword = !_showPassword;
    }

    private void ToggleRepeatPasswordVisibility()
    {
        _showRepeatPassword = !_showRepeatPassword;
    }
}
