@page "/signup"

@inject IAuthApiService authApiService
@inject NavigationManager navigationManager

<AuthorizeView>
    <Authorized>
        @{
            Console.WriteLine("User is already authorized, redirecting to home page.");
            navigationManager.NavigateTo("/");
        }
    </Authorized>
</AuthorizeView>

<MudContainer Style="justify-content: center" MaxWidth="MaxWidth.Small">
    <MudPaper Class="pa-4">
        <MudText Typo="Typo.h4" Align="Align.Center" Color="Color.Secondary" style="margin-bottom:16px">Signup</MudText>
        <MudForm @bind-IsValid="@success" @bind-Errors="@errors">
            <MudTextField @bind-Value="username" T="string" Label="Username" Required="true" RequiredError="User name is required!" Style="margin-bottom:8px" />
            <MudTextField @bind-Value="email" T="string" Label="Email" Required="true" RequiredError="Email is required!"
                Validation="@(new EmailAddressAttribute() {ErrorMessage = "The email address is invalid"})" Style="margin-bottom:8px" />
            <MudTextField @bind-Value="password" T="string" Label="Password" HelperText="Choose a strong password" InputType="InputType.Password"
                           Required="true"
                          Style="margin-bottom:8px" RequiredError="Password is required!" />@* Validation="@(new Func<string, IEnumerable<string>>(validationService.PasswordStrength))" *@
            <MudTextField T="string"
                Label="Password" HelperText="Repeat the password" InputType="InputType.Password"
                          Style="margin-bottom:8px" /> @* Validation="@(new Func<string, string>(PasswordMatch))" *@
        </MudForm>
        <div class="d-flex align-center justify-space-between">
            <MudCheckBox Color="Color.Primary" T="bool" Required="true" RequiredError="You must agree" Label="I agree!" />
            <button disabled="@(!success)" Class="btn btn-primary" onclick="@SignUpAction" style="padding-left: 25px; padding-right: 25px">  Sign up  </button>
        </div>
    </MudPaper>
</MudContainer>

@code {
    bool success;
    string[] errors = { };
    string username = "";
    string email = "";
    string password = "";

    private string PasswordMatch(string arg)
    {
        if (password != arg)
            return "Passwords don't match";
        return String.Empty;
    }

    private async Task SignUpAction()
    {
        if (string.IsNullOrEmpty(username) || string.IsNullOrEmpty(email) ||
            string.IsNullOrEmpty(password))
            return;

        var succeeded = await authApiService.SignupAsync(new RegisterRequestDto(email, password, username));

        if (succeeded)
        {
            navigationManager.NavigateTo("/");
            StateHasChanged();
        }
    }
}
