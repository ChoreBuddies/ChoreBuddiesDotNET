@page "/household/manage"
@using ChoreBuddies.Frontend.Features.ScheduledChores
@using ChoreBuddies.Frontend.Features.User
@using MudBlazor
@using Shared.Households
@using Shared.ScheduledChores
@using Shared.Users

@inject IHouseholdService householdService
@inject IScheduledChoresService scheduledChoresService
@inject NavigationManager navigationManager

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8">

    <!-- ==== Header ==== -->
    <MudText Typo="Typo.h4" Style="font-weight:800;">
        Household Management
    </MudText>
    <MudText Typo="Typo.subtitle1" Color="Color.Secondary" Class="mb-8">
        Manage household settings, members, chores and rewards
    </MudText>

    <!-- ===== Household details ===== -->
    @if (household is not null)
    {
        <HouseholdInvitationCodeDisplay Household="household" />
        <MudPaper Elevation="0" Class="pa-6 mb-8" Style="background:#f5f6f8; border-radius:16px;">
            <div>
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start" Class="mb-3">
                    <MudText Typo="Typo.h5" Style="font-weight:700;">
                        Household Details
                    </MudText>

                    <MudButton Variant="Variant.Outlined"
                               StartIcon="@Icons.Material.Filled.Edit"
                               OnClick="@EditHousehold"
                               Color="Color.Primary"
                               Size="Size.Large"
                               Style="text-transform:none; border-radius:20px;">
                        Edit
                    </MudButton>
                </MudStack>
                <div style="width: 60px; height: 4px; background-color: var(--mud-palette-primary);  border-radius: 2px;" />
            </div>

            <MudGrid Spacing="3">
                <MudItem xs="12" sm="4">
                    <MudText Color="Color.Secondary">Name:</MudText>
                    <MudText Typo="Typo.h6">@household.Name</MudText>
                </MudItem>
                <MudItem xs="12" sm="8">
                    <MudText Color="Color.Secondary">Description:</MudText>
                    <MudText Typo="Typo.body1">@household.Description</MudText>
                </MudItem>
            </MudGrid>
        </MudPaper>
    }
    else
    {
        <MudProgressCircular Indeterminate="true" />
    }

    <!-- ===== Members & roles ===== -->
    <HouseholdMembersManagement/>


    <!-- ===== Recurring chores ===== -->
    <MudText Typo="Typo.h6" Class="mb-4" Style="font-weight:700;">
        Recurring Chores
    </MudText>

    <MudGrid Class="mb-10">
        @foreach (var chore in RecurringChores)
        {
            <MudItem xs="12" md="6">
                <MudPaper Elevation="1" Class="p-4" Style="border-radius:12px;">
                    <MudStack Spacing="1">
                        <MudText Typo="Typo.subtitle1" Style="font-weight:700;">
                            @chore.Name
                        </MudText>

                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            @chore.Description
                        </MudText>

                        <MudText Typo="Typo.caption">
                            Frequency: @chore.Frequency
                        </MudText>

                        <MudStack Spacing="2" Class="mt-2">
                            <MudButton Variant="Variant.Text" Size="Size.Small">
                                Edit
                            </MudButton>
                            <MudButton Variant="Variant.Text"
                                       Color="Color.Error"
                                       Size="Size.Small">
                                Delete
                            </MudButton>
                        </MudStack>
                    </MudStack>
                </MudPaper>
            </MudItem>
        }

        <MudItem xs="12">
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       Style="text-transform:none;">
                Add recurring chore
            </MudButton>
        </MudItem>
    </MudGrid>

    <!-- ===== Reward approvals ===== -->
    <MudText Typo="Typo.h6" Class="mb-4" Style="font-weight:700;">
        Reward Approvals
    </MudText>

    <MudTable Items="PendingRewards" Elevation="0" Style="border-radius:12px;">
        <HeaderContent>
            <MudTh>User</MudTh>
            <MudTh>Reward</MudTh>
            <MudTh>Points</MudTh>
            <MudTh></MudTh>
        </HeaderContent>

        <RowTemplate>
            <MudTd>@context.UserName</MudTd>
            <MudTd>@context.RewardName</MudTd>
            <MudTd>@context.Points</MudTd>
            <MudTd Align="Align.Right">
                <MudStack Direction="Row" Spacing="1">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               Size="Size.Small"
                               Style="text-transform:none;">
                        Approve
                    </MudButton>
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Error"
                               Size="Size.Small"
                               Style="text-transform:none;">
                        Reject
                    </MudButton>
                </MudStack>
            </MudTd>
        </RowTemplate>
    </MudTable>

</MudContainer>

@code {

    // ==== DTOS ====
    private HouseholdDto? household;


    private List<ScheduledChoreTileViewDto> RecurringChores = [];

    // ==== MODELS ====
    private List<PendingReward> PendingRewards = new()
    {
        new PendingReward("Tom", "Movie Night", 500),
        new PendingReward("Tom", "Ice Cream Sundae Bar", 250)
    };

    protected override async Task OnInitializedAsync()
    {
        household = await householdService.GetHouseholdByIdAsync();
        RecurringChores = (await scheduledChoresService.GetMyHouseholdChoresAsync())?.ToList() ?? [];
    }

    public void EditHousehold() => navigationManager.NavigateTo($"/household-details/{household!.Id}");

    public class PendingReward
    {
        public string UserName { get; set; } = "";
        public string RewardName { get; set; } = "";
        public int Points { get; set; }
        public PendingReward(string userName, string rewardName, int pts)
        {
            UserName = userName;
            RewardName = rewardName;
            Points = pts;
        }
    }
}
