@using ChoreBuddies.Frontend.Features.User
@using MudBlazor
@using Shared.Users

@inject IUserService userService
@inject ISnackbar snackbar
@inject IAuthService authService
<MudPaper Elevation="0" Class="pa-6 mb-8" Style="background:#f5f6f8; border-radius:16px;">
    <div>
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start" Class="mb-3">

<MudText Typo="Typo.h5" Class="mb-4" Style="font-weight:700;">
    Household Members
</MudText>
 @if (!_isEditingRoles)
                       {
            <MudButton Variant="Variant.Outlined"
                       StartIcon="@Icons.Material.Filled.Edit"
                       Color="Color.Primary"
                       Size="Size.Large"
                       @onclick="() => _isEditingRoles = true"
                       Style="text-transform:none; border-radius:20px;">
                Edit
            </MudButton>
                       }
    </MudStack>
    <div style="width: 60px; height: 4px; background-color: var(--mud-palette-primary); border-radius: 2px;" />
        </div>




<MudTable T="UserModel"
          Items="MembersModel"
          Elevation="0"
          Class="mb-3"
          Style="border-radius:12px; background:#f5f6f8;">

    <HeaderContent>
        <MudTh>User</MudTh>
        <MudTh>Role</MudTh>
        <MudTh></MudTh>
    </HeaderContent>

    <RowTemplate Context="member">
        <MudTd>@member.UserName</MudTd>

        <MudTd>
            <MudSelect T="string"
                       @bind-Value="member.RoleName"
                       Dense="true"
                       Disabled="@(!_isEditingRoles || _currentUserIsChild || member.Id == _userId)">
                @foreach (var role in AvailableRoles)
                {
                    <MudSelectItem T="string" Value="@role">@role</MudSelectItem>
                }
            </MudSelect>
        </MudTd>
    </RowTemplate>

</MudTable>


    <MudStack Row="true" Justify="Justify.FlexEnd" Style="@($"visibility: {(_isEditingRoles ? "visible" : "hidden")};")">
        @* @if (_isEditingRoles)
        { *@
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Error"
                       Style="width:fit-content; text-transform:none;"
                       @onclick="@CancelEditingRoles">
                Cancel
            </MudButton>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       Style="width:fit-content; text-transform:none;"
                       @onclick="@SaveRoles">
                Save Roles
            </MudButton>
        @* } *@
        @* else
        {
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       Style="width:fit-content; text-transform:none;"
                       @onclick="() => _isEditingRoles = true">
                Edit Roles
            </MudButton>
        } *@
    </MudStack>
</MudPaper>
@code {

    // ==== MODELS ====
    private List<UserModel> MembersModel = [];
    private List<AppUserRoleDto> Members = [];
    private List<string> AvailableRoles = [];

    // ==== STATES ====
    private bool _isEditingRoles = false;
    private int _userId = -1;
    private bool _currentUserIsChild = false;

    protected override async Task OnInitializedAsync()
    {
        AvailableRoles = (await userService.GetAvailableRolesAsync())?.ToList() ?? [];
        Members = (await userService.GetMyHouseholdMembersWithRoleAsync())?.ToList() ?? [];
        _userId = await authService.GetUserIdAsync();

        var currentUserDto = Members.FirstOrDefault(x => x.Id == _userId);
        if (currentUserDto != null)
        {
            _currentUserIsChild = IsChild(currentUserDto.RoleName);
        }
        LoadModels();
    }
    private void LoadModels()
    {
        MembersModel.Clear();
        foreach (var member in Members)
        {
            MembersModel.Add(new(member.Id, member.UserName, member.RoleName));
        }
    }

    private void CancelEditingRoles()
    {
        _isEditingRoles = false;
        LoadModels();
    }

    public bool IsChild(string? role)
    {
        if (string.IsNullOrEmpty(role)) return true; 
        return String.Compare(role, "child", true) == 0;
    }
    private async Task SaveRoles()
    {
        try
        {
            foreach (var userModel in MembersModel)
            {
                var originalUser = Members.FirstOrDefault(m => m.Id == userModel.Id);

                if (originalUser != null && originalUser.RoleName != userModel.RoleName)
                {
                    await userService.UpdateUserRoleAsync(userModel.Id, userModel.RoleName);
                }
            }

            Members = (await userService.GetMyHouseholdMembersWithRoleAsync())?.ToList() ?? [];
            snackbar.Add("Roles updated successfully", Severity.Success);
            _isEditingRoles = false;
        }
        catch (Exception ex)
        {
            snackbar.Add($"Error updating roles: {ex.Message}", Severity.Error);
        }
    }

    // ===== MODELS CLASSES =====
    public class UserModel(int id, string userName, string roleName)
    {
        public int Id { get; set; } = id;
        public string UserName { get; set; } = userName;
        public string RoleName { get; set; } = roleName;
    }
}
